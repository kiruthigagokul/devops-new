pipeline {
    agent any 
    parameters {
        booleanParam( name: 'VALIDATE_TERRAFORM',defaultValue: false, description : 'Check to Validate Terraform Changes')
        booleanParam(name: 'PLAN_TERRAFORM', defaultValue: false, description: 'Check To Plan Terraform Changes')
        booleanParam(name: 'APPLY_TERRAFORM', defaultValue: false, description: 'Check To Apply Terraform Changes')
        booleanParam(name: 'DESTROY_TERRAFORM' , defaultValue: false, description : 'Check To Delete Terraform Changes')
    }
    stages {
        stage ('Clone Repository') {
            steps {
                deleteDir()
                git branch: 'main' ,
                    url: <>
                sh "ls -lart"
            }
        }
        stage ('Terraform Init'){
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding' , credentialsId: 'aws-credentials-gk']]){
                sh 'echo "-------------Terraform Init-----------------"'
                sh 'terraform init' 
                }
            }
        }
        stage ('Terraform validate'){
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding' , credentialsId: 'aws-credentials-gk']]){
                sh 'echo "------------Terraform Validate----------------"'
                sh 'terraform validate'
                }
            }
        }
        stage ('Terraform Plan'){
            steps {
                script {
                    if (params.PLAN_TERRAFORM){
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding' , credentialsId: 'aws-credentials-gk']]){
                        sh 'echo "-----------Terraform Plan----------"'
                        sh 'terraform plan'
                        }

                    }
                }

            }
            
        }
        stage ('Terraform Apply'){
            steps{
                script{
                    if (params.APPLY_TERRAFORM){
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding' , credentialsId:'aws-credentials-gk']]){
                        sh 'echo "------Terraform Apply ----------"'
                        sh 'terraform apply -auto-approve'
                        sh 'echo "saving terraform output to output.txt"'
                        sh 'terraform output > output.txt'
                        sh "ls -lart"
                        }
                    }
                }
            }
        }
        stage ('Terraform Destroy'){
            steps{
                script{
                    if(params.DESTROY_TERRAFORM){
                        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding' , credentialsId:'aws-credentials-gk']]){
                        sh 'echo "----------Terraform Destroy---------"'
                        sh 'terraform destroy -auto-approve'
                    }
                    sh 'echo "--------Before Cleaning Workspace--------"'
                    sh 'ls -lart'
                    cleanWs()
                    sh 'echo "--------After Cleaning Workspace--------"'
                    sh 'ls -lart'
                    }
                }
            }
        }
    }
post {
    success {
        echo 'Terraform executed Successfully !'
    }
    failure {
        echo 'Terraform Execution Failed !'
    }
}
}